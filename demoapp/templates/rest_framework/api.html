{% extends "rest_framework/base.html" %}
{% load rest_framework %}

{% block content %}
<div class="request-info">
    <div class="page-header">
        <h1>
            {% if "reports" in request.path %}
                üìä Task Reports & Analytics
            {% elif "weather" in request.path %}
                üå§Ô∏è Weather Information
            {% else %}
                {{ name|default:"API Endpoint" }}
            {% endif %}
        </h1>
        {% if description %}
        <p class="lead">{{ description }}</p>
        {% endif %}
        <div class="api-actions" style="margin-top: 1rem;">
            <a href="/api/tasks/" class="btn btn-primary btn-sm">
                <span class="glyphicon glyphicon-list"></span> View All Tasks
            </a>
            <a href="/" class="btn btn-success btn-sm">
                <span class="glyphicon glyphicon-dashboard"></span> Dashboard
            </a>
            {% if "reports" in request.path %}
            <a href="/api/tasks/" class="btn btn-info btn-sm">
                <span class="glyphicon glyphicon-plus"></span> Create Task
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="response-info">
    <div class="meta">
        <div class="row">
            <div class="col-md-6">
                <strong>HTTP {{ request.method }}</strong> 
                <code style="background: rgba(102, 126, 234, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px;">{{ request.get_full_path }}</code>
            </div>
            <div class="col-md-6 text-right">
                <strong>Status:</strong> <span class="label label-success" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚úì 200 OK</span>
            </div>
        </div>
    </div>
    
    <!-- User-friendly data display for reports -->
    {% if "reports" in request.path and content %}
    <div id="report-data-display" style="margin-top: 2rem;">
        <div class="row">
            <div class="col-md-12">
                <h3 style="margin-bottom: 1.5rem; color: #667eea;">
                    <span class="glyphicon glyphicon-stats"></span> Statistics Overview
                </h3>
            </div>
        </div>
        
        <div class="row" id="stats-cards">
            <!-- Stats will be populated by JavaScript -->
        </div>
        
        <div class="row" style="margin-top: 2rem;">
            <div class="col-md-12">
                <h4 style="margin-bottom: 1rem; color: #764ba2;">
                    <span class="glyphicon glyphicon-list-alt"></span> Raw JSON Response
                </h4>
                <div class="highlight" style="position: relative;">
                    <button onclick="copyToClipboard()" class="btn btn-sm" style="position: absolute; top: 10px; right: 10px; background: rgba(102, 126, 234, 0.1); border: none; color: #667eea;">
                        <span class="glyphicon glyphicon-copy"></span> Copy
                    </button>
                    <pre style="margin: 0;"><code id="json-content">{{ content|safe }}</code></pre>
                </div>
            </div>
        </div>
    </div>
    {% elif content %}
    <div style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4 style="margin: 0; color: #667eea;">
                <span class="glyphicon glyphicon-file"></span> Response Data
            </h4>
            <button onclick="copyToClipboard()" class="btn btn-sm" style="background: rgba(102, 126, 234, 0.1); border: none; color: #667eea;">
                <span class="glyphicon glyphicon-copy"></span> Copy JSON
            </button>
        </div>
        <div class="highlight">
            <pre style="margin: 0;"><code id="json-content">{{ content|safe }}</code></pre>
        </div>
    </div>
    {% elif data %}
    <div style="margin-top: 1.5rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h4 style="margin: 0; color: #667eea;">
                <span class="glyphicon glyphicon-file"></span> Response Data
            </h4>
            <button onclick="copyToClipboard()" class="btn btn-sm" style="background: rgba(102, 126, 234, 0.1); border: none; color: #667eea;">
                <span class="glyphicon glyphicon-copy"></span> Copy JSON
            </button>
        </div>
        <div class="highlight">
            <pre style="margin: 0;"><code id="json-content">{{ data|safe }}</code></pre>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block script %}
{{ block.super }}
<script>
// Parse and display report data in a user-friendly way
(function() {
    'use strict';
    
    function initReportDisplay() {
        const jsonContent = document.getElementById('json-content');
        if (!jsonContent || !jsonContent.textContent) return;
        
        try {
            const text = jsonContent.textContent.trim();
            if (!text) return;
            
            const data = JSON.parse(text);
            
            // If it's report data, display it nicely
            if (data.total !== undefined && data.by_status !== undefined && data.by_priority !== undefined) {
                displayReportData(data);
            }
        } catch (e) {
            console.log('Not JSON or already formatted:', e);
        }
    }
    
    function displayReportData(data) {
        const statsContainer = document.getElementById('stats-cards');
        if (!statsContainer) return;
        
        // Total tasks card
        const totalCard = createStatCard(
            'Total Tasks',
            data.total || 0,
            'üìã',
            'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
            '/api/tasks/'
        );
        
        // Status breakdown
        let statusHtml = '';
        if (data.by_status && data.by_status.length > 0) {
            data.by_status.forEach(function(item) {
                const statusName = item.status.charAt(0).toUpperCase() + item.status.slice(1);
                const statusColor = item.status === 'done' ? '#10b981' : 
                                  item.status === 'doing' ? '#f59e0b' : '#3b82f6';
                statusHtml += createStatusBadge(statusName, item.count, statusColor);
            });
        } else {
            statusHtml = '<p class="text-muted">No tasks yet. <a href="/api/tasks/">Create your first task!</a></p>';
        }
        
        const statusCard = '<div class="col-md-6" style="margin-bottom: 1.5rem;">' +
            '<div style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #667eea;">' +
            '<h4 style="margin-top: 0; color: #667eea; font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">üìä Tasks by Status</h4>' +
            '<div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">' + statusHtml + '</div>' +
            '</div></div>';
        
        // Priority breakdown
        let priorityHtml = '';
        if (data.by_priority && data.by_priority.length > 0) {
            data.by_priority.forEach(function(item) {
                const priorityLabel = getPriorityLabel(item.priority);
                const priorityColor = getPriorityColor(item.priority);
                priorityHtml += createPriorityBadge(priorityLabel, item.count, priorityColor);
            });
        } else {
            priorityHtml = '<p class="text-muted">No priority data available</p>';
        }
        
        const priorityCard = '<div class="col-md-6" style="margin-bottom: 1.5rem;">' +
            '<div style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #764ba2;">' +
            '<h4 style="margin-top: 0; color: #764ba2; font-size: 1rem; font-weight: 600; margin-bottom: 1rem;">üéØ Tasks by Priority</h4>' +
            '<div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">' + priorityHtml + '</div>' +
            '</div></div>';
        
        statsContainer.innerHTML = '<div class="col-md-12" style="margin-bottom: 1.5rem;">' + totalCard + '</div>' + statusCard + priorityCard;
    }
    
    function createStatCard(title, value, icon, gradient, link) {
        return '<div style="background: ' + gradient + '; border-radius: 16px; padding: 2rem; color: white; text-align: center; box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3); transition: transform 0.3s ease; cursor: pointer;" ' +
               'onclick="window.location.href=\'' + link + '\'" ' +
               'onmouseover="this.style.transform=\'translateY(-5px)\'" ' +
               'onmouseout="this.style.transform=\'translateY(0)\'">' +
               '<div style="font-size: 3rem; margin-bottom: 0.5rem;">' + icon + '</div>' +
               '<div style="font-size: 2.5rem; font-weight: 800; margin-bottom: 0.5rem;">' + value + '</div>' +
               '<div style="font-size: 1rem; opacity: 0.9;">' + title + '</div>' +
               '</div>';
    }
    
    function createStatusBadge(name, count, color) {
        return '<div style="background: ' + color + '; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">' +
               '<span>' + count + '</span>' +
               '<span>' + name + '</span>' +
               '</div>';
    }
    
    function createPriorityBadge(label, count, color) {
        return '<div style="background: ' + color + '; color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-weight: 600; display: inline-flex; align-items: center; gap: 0.5rem;">' +
               '<span>' + count + '</span>' +
               '<span>' + label + '</span>' +
               '</div>';
    }
    
    function getPriorityLabel(priority) {
        const labels = {1: 'Critical', 2: 'High', 3: 'Medium', 4: 'Low', 5: 'Very Low'};
        return labels[priority] || 'Priority ' + priority;
    }
    
    function getPriorityColor(priority) {
        const colors = {
            1: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
            2: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            3: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
            4: 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)',
            5: 'linear-gradient(135deg, #9ca3af 0%, #6b7280 100%)'
        };
        return colors[priority] || colors[3];
    }
    
    window.copyToClipboard = function() {
        const content = document.getElementById('json-content');
        if (!content) return;
        
        const text = content.textContent || content.innerText;
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
                const btn = event.target.closest('button');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<span class="glyphicon glyphicon-ok"></span> Copied!';
                    btn.style.background = 'rgba(16, 185, 129, 0.2)';
                    setTimeout(function() {
                        btn.innerHTML = originalText;
                        btn.style.background = 'rgba(102, 126, 234, 0.1)';
                    }, 2000);
                }
            });
        }
    };
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initReportDisplay);
    } else {
        initReportDisplay();
    }
})();
</script>

<style>
.api-actions .btn {
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
}

.api-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

